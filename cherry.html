<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />

		<title>Cherry</title>

		<!-- <link rel="stylesheet" href="style.css" /> -->

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

		<!-- Bootstrap -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
			crossorigin="anonymous"
		/>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
			crossorigin="anonymous"
		></script>

		<style>
			.marks > div {
				display: grid;
				grid-template-columns: 4fr 2fr 2fr 1fr;
			}

			.svgWrapper {
				position: relative;
				margin: 20px 50px;
			}
			#svg {
				border: 1px solid #ddddddbb;
				box-sizing: border-box;
				position: absolute;
				top: 0;
				left: 0;
				z-index: 10;
			}
			#svg,
			.svgBackground {
				height: calc(100vh - 40px);
				width: calc((100vh - 40px) * (974 / 842));
			}
			.svgBackground {
				position: absolute;
				top: 0;
				left: 0;
				z-index: 1;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="col-3">
					<div class="row gy-3 gx-2 mb-1 align-items-center">
						<div class="col-1"><b>&nbsp;</b></div>
						<div class="col-5"><b>Min</b></div>
						<div class="col-5"><b>Max</b></div>
					</div>
					<div class="row gy-3 gx-2 mb-1 align-items-center">
						<div class="col-1"><b>X</b></div>
						<!-- Text Input -->
						<div class="col-5">
							<input type="number" id="minX" name="minX" class="form-control-sm minMax" />
						</div>
						<div class="col-5">
							<input type="number" id="maxX" name="maxX" class="form-control-sm minMax" />
						</div>
					</div>
					<div class="row gy-3 gx-2 mb-2 align-items-center">
						<div class="col-1"><b>Z</b></div>
						<!-- Text Input -->
						<div class="col-5">
							<input type="number" id="minZ" name="minZ" class="form-control-sm minMax" />
						</div>
						<div class="col-5">
							<input type="number" id="maxZ" name="maxZ" class="form-control-sm minMax" />
						</div>
					</div>

					<hr />

					<div class="row gy-3 gx-2 align-items-center">
						<!-- Text Input -->
						<div class="col-6">
							<input type="text" id="newValue" class="form-control-sm" />
						</div>

						<!-- Type DropDown -->
						<div class="col-4">
							<select id="markType" class="form-select form-select-sm" aria-label=".form-select-sm mark-type"></select>
						</div>

						<!-- Submit Button -->
						<div class="col-2">
							<button class="btn btn-outline-secondary btn-sm" type="button" id="submit">Add</button>
						</div>
					</div>

					<div id="coords" class="coords">
						<div class="marks">
							<div><b>Type</b><b>X</b><b>Z</b><b>&nbsp;</b></div>
						</div>
						<div id="marks" class="marks"></div>
					</div>
				</div>
				<div class="col-6">
					<div class="axis axis-x"></div>
					<div class="axis axis-y"></div>
					<div class="svgWrapper">
						<svg id="svg" width="calc((100vh - 40px) * (974 / 842))" height="calc(100vh - 40px)">
							<polygon points="50,10 0,190 100,190" fill="lime" />
						</svg>
						<img src="./images/cherry.png" alt="background image" class="svgBackground" />
					</div>
				</div>
				<div class="col-3">
					<div class="d-flex flex-row align-items-center gx-3" style="gap: 10px">
						<b>Position: </b>
						<div class="d-flex flex-row align-items-center gx-3" style="gap: 10px">
							<div class="" id="mousePosX">0</div>
							<div class="" id="mousePosY">0</div>
						</div>
						<b>Coordinates: </b>
						<div class="d-flex flex-row align-items-center gx-3" style="gap: 10px">
							<div class="" id="mouseCoordX">0</div>
							<div class="" id="mouseCoordZ">0</div>
						</div>
					</div>
					<div>
						<button class="btn btn-outline-secondary btn-sm" type="button" id="startPolygon">Start</button>
						<b style="display: none" id="drawingPolygon">Drawing</b>
						<div id="polygonCoords"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- <script src="index.js"></script> -->
		<script>
			$(document).ready(function () {
				// markList:
				// {"cfxfkebf8mh":{"id":"cfxfkebf8mh","type":"village","x":"10056","z":"-1384"},"j38xxqa26w":{"id":"j38xxqa26w","type":"village","x":"10056","z":"-888"},"02ldrjqqjmrf":{"id":"02ldrjqqjmrf","type":"village","x":"9560","z":"-392"},"n780jwlvmxb":{"id":"n780jwlvmxb","type":"village","x":"10120","z":"-344"},"hxjzfvbzeb":{"id":"hxjzfvbzeb","type":"village","x":"10424","z":"-152"},"fvyfu5480yj":{"id":"fvyfu5480yj","type":"village","x":"11112","z":"-856"},"zccxypcow6":{"id":"zccxypcow6","type":"village","x":"11144","z":"40"},"mgd6ox354fe":{"id":"mgd6ox354fe","type":"village","x":"9944","z":"248"},"spt7nxic8zt":{"id":"spt7nxic8zt","type":"village","x":"9336","z":"840"},"zwnw0a0y1d":{"id":"zwnw0a0y1d","type":"pillagerOutpost","x":"9592","z":"280"},"2q1i2mobd1e":{"id":"2q1i2mobd1e","type":"pillagerOutpost","x":"10952","z":"-872"},"jbc9f0kjgar":{"id":"jbc9f0kjgar","type":"ancientCity","x":"10072","z":"-1064"},"nod1qqltb18":{"id":"nod1qqltb18","type":"ancientCity","x":"10504","z":"-968"},"clb7j3cvidn":{"id":"clb7j3cvidn","type":"ancientCity","x":"9416","z":"-648"},"j8xg1v7cc2a":{"id":"j8xg1v7cc2a","type":"ancientCity","x":"9768","z":"-632"},"p30psop6rv":{"id":"p30psop6rv","type":"ancientCity","x":"10504","z":"-696"},"aa86a04ydge":{"id":"aa86a04ydge","type":"ancientCity","x":"10856","z":"-648"},"pxj6byq7itn":{"id":"pxj6byq7itn","type":"ancientCity","x":"10840","z":"-312"},"yejpvbpfk4j":{"id":"yejpvbpfk4j","type":"ancientCity","x":"11208","z":"-296"},"jiadv4ngg3":{"id":"jiadv4ngg3","type":"ancientCity","x":"10088","z":"472"},"ckciu954839":{"id":"ckciu954839","type":"ancientCity","x":"10152","z":"-696"},"diy1pphbs8f":{"id":"diy1pphbs8f","type":"shipwreck","x":"9048","z":"-904"},"4a5dz4jhnm8":{"id":"4a5dz4jhnm8","type":"shipwreck","x":"9128","z":"-1288"},"c3jbus6cvbs":{"id":"c3jbus6cvbs","type":"shipwreck","x":"9096","z":"-1704"},"gk13rcbpc5o":{"id":"gk13rcbpc5o","type":"shipwreck","x":"9288","z":"-1816"},"ylq6dxp4vvj":{"id":"ylq6dxp4vvj","type":"shipwreck","x":"9736","z":"-1864"},"vj5rru8sakr":{"id":"vj5rru8sakr","type":"shipwreck","x":"10088","z":"-1608"},"b2qnjaja774":{"id":"b2qnjaja774","type":"shipwreck","x":"9624","z":"424"},"2m62eud36jp":{"id":"2m62eud36jp","type":"shipwreck","x":"9496","z":"792"},"gjg01dez19e":{"id":"gjg01dez19e","type":"portal","x":"9192","z":"-1784"},"75jjufveom":{"id":"75jjufveom","type":"portal","x":"9800","z":"-1576"},"hb6y09adykh":{"id":"hb6y09adykh","type":"portal","x":"9256","z":"-1192"},"c8gbmhml46f":{"id":"c8gbmhml46f","type":"portal","x":"9688","z":"-1096"},"p1w0b8f15n8":{"id":"p1w0b8f15n8","type":"portal","x":"10440","z":"-1080"},"de14ijidym":{"id":"de14ijidym","type":"portal","x":"10936","z":"-1192"},"oxr3nadxwz":{"id":"oxr3nadxwz","type":"portal","x":"9064","z":"-264"},"ugignremz79":{"id":"ugignremz79","type":"portal","x":"9944","z":"-488"},"2qfm55h4ioq":{"id":"2qfm55h4ioq","type":"portal","x":"10328","z":"-520"},"ymbz3mc90zk":{"id":"ymbz3mc90zk","type":"portal","x":"10984","z":"-600"},"m1iptxef6pc":{"id":"m1iptxef6pc","type":"portal","x":"9256","z":"216"},"5b1462rxzs":{"id":"5b1462rxzs","type":"portal","x":"9736","z":"104"},"4r1asvglaau":{"id":"4r1asvglaau","type":"portal","x":"10280","z":"264"},"mx9aovfbek":{"id":"mx9aovfbek","type":"portal","x":"11080","z":"72"},"gszj4qml6z7":{"id":"gszj4qml6z7","type":"portal","x":"9304","z":"760"},"vr5xiqf1ip":{"id":"vr5xiqf1ip","type":"portal","x":"9896","z":"792"},"dd972ve5j3k":{"id":"dd972ve5j3k","type":"portal","x":"8632","z":"280"},"4risopt4hte":{"id":"4risopt4hte","type":"portal","x":"11192","z":"888"},"xyeppw824j":{"id":"xyeppw824j","type":"portal","x":"10360","z":"936"},"lzofohrd26n":{"id":"lzofohrd26n","type":"shipwreck","x":"10984","z":"952"},"8l26p3qrzyn":{"id":"8l26p3qrzyn","type":"smallRuin","x":"9096","z":"-1160"},"ajs0dq53ei":{"id":"ajs0dq53ei","type":"smallRuin","x":"9288","z":"-1256"},"pzwhztnlrm":{"id":"pzwhztnlrm","type":"smallRuin","x":"8968","z":"-1544"},"olqfe2kjurc":{"id":"olqfe2kjurc","type":"smallRuin","x":"9144","z":"-1896"},"cbqwj7gfbxl":{"id":"cbqwj7gfbxl","type":"largeRuin","x":"9336","z":"-1848"},"rjg17moyl5":{"id":"rjg17moyl5","type":"largeRuin","x":"9624","z":"-1784"},"y60cof8cnia":{"id":"y60cof8cnia","type":"smallRuin","x":"10040","z":"-1768"},"8tjjc3uyjow":{"id":"8tjjc3uyjow","type":"smallRuin","x":"10392","z":"-1496"},"i1nhyc6ujw8":{"id":"i1nhyc6ujw8","type":"smallRuin","x":"11016","z":"1064"},"dypqfmjo6ek":{"id":"dypqfmjo6ek","type":"largeRuin","x":"10568","z":"968"},"bwukou0qwsc":{"id":"bwukou0qwsc","type":"smallRuin","x":"9768","z":"792"},"u23sq2thi8":{"id":"u23sq2thi8","type":"smallRuin","x":"9736","z":"456"},"ipywof83tz":{"id":"ipywof83tz","type":"smallRuin","x":"9464","z":"728"},"2z7cjwwaxnl":{"id":"2z7cjwwaxnl","type":"smallRuin","x":"10744","z":"-1496"}}

				// svgInfo:
				// {"minX":"8143","maxX":"12034","minZ":"-2153","maxZ":"1215"}

				// console.log("--document.read--");
				const listInfo = {
					village: { label: "Village", color: "brown" },
					ancientCity: { label: "Ancient City", color: "aqua" },
					pillagerOutpost: { label: "Pillager Outpost", color: "maroon" },
					portal: { label: "Portal", color: "RebeccaPurple" },
					smallRuin: { label: "Small Ruin", color: "SkyBlue" },
					largeRuin: { label: "Large Ruin", color: "yellow" },
					shipwreck: { label: "Shipwreck", color: "chocolate" },
				};
				var svgWindow = {
						width: 100,
						height: 100,
						left: 0,
						top: 0,
					},
					svgInfo = {
						minX: 0,
						maxX: svgWindow.width,
						minZ: 0,
						maxZ: svgWindow.height,
					},
					isDrawing,
					addingPoly = {},
					mousePosX,
					mousePosY,
					mouseCoordX,
					mouseCoordZ;

				// ////////
				// init
				function init() {
					// mark options
					// console.log(":::initOptions:::");
					Object.entries(listInfo).forEach(function ([val, { label }]) {
						$("#markType").append($("<option></option>").val(val).text(label));
					});

					// minMax inputs
					// console.log(":::initMinMax:::");
					const loc = _getLocalStorage("svgInfo");
					const minMaxDisplay = Object.entries(svgInfo).reduce(function (d, [k, v]) {
						if (!loc[k]) updateMinMax(k, v);
						d[k] = Number(loc[k]) ?? v;
						return d;
					}, {});
					// console.log("minMaxDisplay: ", minMaxDisplay);
					svgInfo = minMaxDisplay;
					displayMinMax(minMaxDisplay);

					// get svg size and display marks
					getWindowSize();
				}
				init();

				// ///////////
				// helpers

				// storage
				function _setLocalStorage(listKey, value) {
					localStorage.removeItem(listKey);
					localStorage.setItem(listKey, JSON.stringify(value));
				}
				function _getLocalStorage(keyName) {
					return JSON.parse(localStorage.getItem(keyName) ?? "{}");
				}

				// crud
				function createMark(value) {
					// console.log("--createMark--");
					const type = $("#markType").val(),
						id = createID(),
						oldList = _getLocalStorage("markList");

					if (value && type && id) {
						const valueSplit = value.split(" ");
						// console.log("valueSplit: ", valueSplit);

						const newMark = {
							id,
							type,
							x: valueSplit[1],
							z: valueSplit[3],
						};
						const newList = {
							...oldList,
							[id]: newMark,
						};
						// console.log("newMark: ", newMark);

						_setLocalStorage("markList", newList);

						displayMarks(newList);

						$("#newValue").val("");
					}
				}
				function createID() {
					// console.log("--createID--");
					return Math.random()
						.toString(36)
						.substring(2, 12 + 2);
				}
				function updateMinMax(name, value) {
					// console.log("--updateMinMax--");
					const oldList = _getLocalStorage("svgInfo");
					const newList = { ...oldList, [name]: value };
					svgInfo[name] = value;
					// console.log(name, ": ", value);
					_setLocalStorage("svgInfo", newList);
				}

				// //////////
				// Render

				// display
				function displayMarks(marks = null) {
					// console.log("--displayMarks--");
					if (!marks) marks = _getLocalStorage("markList");

					// clear
					$("#marks").html("");
					$("#svg").html("");

					Object.entries(marks).forEach(function ([key, mark]) {
						// console.log("mark: ", mark);
						const { id, type, x, z } = mark;

						// mark list
						$("#marks").append(
							$("<div id='" + id + "'></div>")
								.append($("<div></div>").text(type))
								.append($("<div></div>").text(x))
								.append($("<div></div>").text(z))
								.append($("<div></div>").append($(`<button class="btn btn-outline-secondary btn-sm">X</button>`)))
						);

						// svg
						$("#svg").html($("#svg").html() + rect(10, 10, translateX(x), translateZ(z), listInfo[type].color));
					});
				}
				function displayMinMax(minMaxDisplay) {
					// console.log("--displayMinMax--");
					if (!minMaxDisplay) minMaxDisplay = svgInfo;
					Object.entries(minMaxDisplay).forEach(function ([k, v]) {
						$("#" + k).val(v);
					});
				}
				function getWindowSize() {
					// console.log("--getWindowSize--");

					svgWindow = {
						height: Math.floor($("#svg").height()),
						width: Math.floor(Math.floor($("#svg").height()) * (974 / 842)),
						top: $("#svg").position().top,
						left: $("#svg").position().left,
					};
					// console.log("svgWindow: ", svgWindow);

					// re-render
					displayMarks();
				}

				// svg helpers
				function rect(width, height, x, z, fill) {
					x = x - width / 2;
					z = z - height / 2;
					return `<rect width="${width}" height="${height}" x="${x}" y="${z}" fill="${fill}" />`;
				}
				function translateX(x) {
					return Math.abs((x - svgInfo.minX) / (svgInfo.maxX - svgInfo.minX)) * svgWindow.width;
				}
				function translateZ(z) {
					return Math.abs((z - svgInfo.minZ) / (svgInfo.maxZ - svgInfo.minZ)) * svgWindow.height;
				}

				// ///////////
				// on handlers

				// on enter
				$("#newValue").on("keypress", function (e) {
					// console.log("--#newValue on keypress--");
					const v = e.target.value;
					// if enter key
					if (e.which == 13 && v) {
						createMark(v);
					}
				});
				// on any key
				$(".minMax").on("change click keyup input paste", function (e) {
					// console.log("--.minMax on change--");
					updateMinMax(e.target.name, e.target.value);
				});
				// on submit
				$("#submit").on("click", function (e) {
					// console.log("--#submit on click--");
					const v = $("#newValue").val();
					if (v) createMark(v);
				});

				// window resize
				$(window).on("resize", function () {
					getWindowSize();
				});

				// mouse over
				$("#svg").on("mousemove", function (event) {
					mousePosX = Math.floor(event.pageX - svgWindow.left);
					mousePosY = Math.floor(event.pageY - svgWindow.top);
					$("#mousePosX").text(mousePosX);
					$("#mousePosY").text(mousePosY);

					mouseCoordX = Math.floor((mousePosX / svgWindow.width) * Math.abs(svgInfo.maxX - svgInfo.minX) + svgInfo.minX);
					mouseCoordZ = Math.floor((mousePosY / svgWindow.height) * Math.abs(svgInfo.maxZ - svgInfo.minZ) + svgInfo.minZ);
					$("#mouseCoordX").text(mouseCoordX);
					$("#mouseCoordZ").text(mouseCoordZ);
				});

				// draw polygon
				$("#startPolygon").on("click", function () {
					isDrawing = true;
					$(this).hide();
					$("#drawingPolygon").show();
				});
				$("#svg").on("click", function () {
					if (isDrawing) {
						addingPoly[Object.keys(addingPoly).length] = { x: mouseCoordX, z: mouseCoordZ };
						$("#polygonCoords").html($("#polygonCoords").html() + `<p>${mouseCoordX} ${mouseCoordZ}</p>`);
					}
				});
			});
		</script>
	</body>
</html>
