<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />

		<title>Cherry</title>

		<!-- <link rel="stylesheet" href="style.css" /> -->

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

		<!-- Bootstrap -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
			crossorigin="anonymous"
		/>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
			crossorigin="anonymous"
		></script>

		<!-- Font Awesome -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

		<style>
			.marks > * {
				display: grid;
				grid-template-columns: 15px 4fr 2fr 2fr 2fr;
			}
			.marks > * > *:first-child {
				width: 10px;
				display: block;
				border: 1px solid #4442;
			}
			.marks > * > *:last-child > * {
				padding: 3px;
				margin-right: 4px;
				box-sizing: border-box;
				display: inline-block;
			}

			.polys > * {
				display: grid;
				grid-template-columns: 15px 4fr 2fr;
				align-items: center;
			}
			.polys > * > *:first-child {
				width: 10px;
				display: block;
				height: 100%;
				border: 1px solid #4442;
			}
			.polys > * > *:nth-child(2) {
				display: grid;
				grid-template-columns: 1fr 1fr;
			}
			.polys > * > *:last-child > * {
				padding: 3px;
				margin-right: 4px;
				box-sizing: border-box;
				display: inline-block;
			}

			.svgWrapper {
				position: relative;
				margin: 20px 50px;
			}
			#svg {
				border: 1px solid #ddddddbb;
				box-sizing: border-box;
				position: absolute;
				top: 0;
				left: 0;
				z-index: 10;
			}
			#svg,
			.svgBackground {
				height: calc(100vh - 40px);
				width: calc((100vh - 40px) * (974 / 842));
			}
			.svgBackground {
				position: absolute;
				top: 0;
				left: 0;
				z-index: 1;
				opacity: 0.5;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="col-3">
					<div class="row gy-3 gx-2 mb-1 align-items-center">
						<div class="col-1"><b>&nbsp;</b></div>
						<div class="col-5"><b>X</b></div>
						<div class="col-5"><b>Z</b></div>
					</div>
					<div class="row gy-3 gx-2 mb-1 align-items-center">
						<div class="col-1">
							<b>Min</b>
						</div>
						<div class="col-5">
							<input type="number" id="minX" name="minX" class="form-control-sm minMax" />
						</div>
						<div class="col-5">
							<input type="number" id="minZ" name="minZ" class="form-control-sm minMax" />
						</div>
					</div>
					<div class="row gy-3 gx-2 mb-2 align-items-center">
						<div class="col-1">
							<b>Max</b>
						</div>
						<div class="col-5">
							<input type="number" id="maxX" name="maxX" class="form-control-sm minMax" />
						</div>

						<div class="col-5">
							<input type="number" id="maxZ" name="maxZ" class="form-control-sm minMax" />
						</div>
					</div>

					<hr />

					<div class="row gy-3 gx-2 mb-2 align-items-center">
						<!-- Text Input -->
						<div class="col-6">
							<input type="text" id="newValue" class="form-control-sm" />
						</div>

						<!-- Type DropDown -->
						<div class="col-4">
							<select id="markType" class="form-select form-select-sm" aria-label=".form-select-sm mark-type"></select>
						</div>

						<!-- Submit Button -->
						<div class="col-2">
							<button class="btn btn-outline-secondary btn-sm" type="button" id="submit">Add</button>
						</div>
					</div>

					<div id="coords" class="coords">
						<div class="marks mb-1">
							<div><span>&nbsp;</span><b>Type</b><b>X</b><b>Z</b><b>&nbsp;</b></div>
						</div>
						<div id="marksTable" class="marks"></div>
					</div>
				</div>
				<div class="col-6">
					<div class="axis axis-x"></div>
					<div class="axis axis-y"></div>
					<button id="reset">Reset</button>
					<div class="svgWrapper">
						<svg id="svg" width="calc((100vh - 40px) * (974 / 842))" height="calc(100vh - 40px)">
							<rect width="200" height="200" x="200" y="200" fill="red" />
						</svg>
						<img src="./images/cherry.png" alt="background image" class="svgBackground" />
					</div>
				</div>
				<div class="col-3">
					<div class="d-flex flex-row align-items-center gx-3" style="gap: 10px">
						<b>Position: </b>
						<div class="d-flex flex-row align-items-center gx-3" style="gap: 10px">
							<div class="" id="mousePosX">0</div>
							<div class="" id="mousePosY">0</div>
						</div>
						<b>Coordinates: </b>
						<div class="d-flex flex-row align-items-center gx-3" style="gap: 10px">
							<div class="" id="mouseCoordX">0</div>
							<div class="" id="mouseCoordZ">0</div>
						</div>
					</div>
					<div>
						<div class="mb-2">
							<button class="btn btn-outline-secondary btn-sm" type="button" id="startPolygon">Start</button>
							<div id="saveCancel" style="display: none">
								<b id="status"></b>
								<button class="btn btn-outline-secondary btn-sm" type="button" id="savePolygon">Save</button>
								<button class="btn btn-outline-secondary btn-sm" type="button" id="cancelPolygon">Cancel</button>
								<input type="color" id="polyColor" value="#FFFFFF" />
								<div id="polygonCoords"></div>
							</div>
						</div>
						<div id="polys">
							<div class="polys mb-1">
								<div>
									<span>&nbsp;</span><span><b>X</b><b>Z</b></span
									><b>&nbsp;</b>
								</div>
							</div>
							<div id="polyTable" class="polys"></div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- <script src="index.js"></script> -->
		<script>
			$(document).ready(function () {
				// markList:
				// {"cfxfkebf8mh":{"id":"cfxfkebf8mh","type":"village","x":"10056","z":"-1384"},"j38xxqa26w":{"id":"j38xxqa26w","type":"village","x":"10056","z":"-888"},"02ldrjqqjmrf":{"id":"02ldrjqqjmrf","type":"village","x":"9560","z":"-392"},"n780jwlvmxb":{"id":"n780jwlvmxb","type":"village","x":"10120","z":"-344"},"hxjzfvbzeb":{"id":"hxjzfvbzeb","type":"village","x":"10424","z":"-152"},"fvyfu5480yj":{"id":"fvyfu5480yj","type":"village","x":"11112","z":"-856"},"zccxypcow6":{"id":"zccxypcow6","type":"village","x":"11144","z":"40"},"mgd6ox354fe":{"id":"mgd6ox354fe","type":"village","x":"9944","z":"248"},"spt7nxic8zt":{"id":"spt7nxic8zt","type":"village","x":"9336","z":"840"},"zwnw0a0y1d":{"id":"zwnw0a0y1d","type":"pillagerOutpost","x":"9592","z":"280"},"2q1i2mobd1e":{"id":"2q1i2mobd1e","type":"pillagerOutpost","x":"10952","z":"-872"},"jbc9f0kjgar":{"id":"jbc9f0kjgar","type":"ancientCity","x":"10072","z":"-1064"},"nod1qqltb18":{"id":"nod1qqltb18","type":"ancientCity","x":"10504","z":"-968"},"clb7j3cvidn":{"id":"clb7j3cvidn","type":"ancientCity","x":"9416","z":"-648"},"j8xg1v7cc2a":{"id":"j8xg1v7cc2a","type":"ancientCity","x":"9768","z":"-632"},"p30psop6rv":{"id":"p30psop6rv","type":"ancientCity","x":"10504","z":"-696"},"aa86a04ydge":{"id":"aa86a04ydge","type":"ancientCity","x":"10856","z":"-648"},"pxj6byq7itn":{"id":"pxj6byq7itn","type":"ancientCity","x":"10840","z":"-312"},"yejpvbpfk4j":{"id":"yejpvbpfk4j","type":"ancientCity","x":"11208","z":"-296"},"jiadv4ngg3":{"id":"jiadv4ngg3","type":"ancientCity","x":"10088","z":"472"},"ckciu954839":{"id":"ckciu954839","type":"ancientCity","x":"10152","z":"-696"},"diy1pphbs8f":{"id":"diy1pphbs8f","type":"shipwreck","x":"9048","z":"-904"},"4a5dz4jhnm8":{"id":"4a5dz4jhnm8","type":"shipwreck","x":"9128","z":"-1288"},"c3jbus6cvbs":{"id":"c3jbus6cvbs","type":"shipwreck","x":"9096","z":"-1704"},"gk13rcbpc5o":{"id":"gk13rcbpc5o","type":"shipwreck","x":"9288","z":"-1816"},"ylq6dxp4vvj":{"id":"ylq6dxp4vvj","type":"shipwreck","x":"9736","z":"-1864"},"vj5rru8sakr":{"id":"vj5rru8sakr","type":"shipwreck","x":"10088","z":"-1608"},"b2qnjaja774":{"id":"b2qnjaja774","type":"shipwreck","x":"9624","z":"424"},"2m62eud36jp":{"id":"2m62eud36jp","type":"shipwreck","x":"9496","z":"792"},"gjg01dez19e":{"id":"gjg01dez19e","type":"portal","x":"9192","z":"-1784"},"75jjufveom":{"id":"75jjufveom","type":"portal","x":"9800","z":"-1576"},"hb6y09adykh":{"id":"hb6y09adykh","type":"portal","x":"9256","z":"-1192"},"c8gbmhml46f":{"id":"c8gbmhml46f","type":"portal","x":"9688","z":"-1096"},"p1w0b8f15n8":{"id":"p1w0b8f15n8","type":"portal","x":"10440","z":"-1080"},"de14ijidym":{"id":"de14ijidym","type":"portal","x":"10936","z":"-1192"},"oxr3nadxwz":{"id":"oxr3nadxwz","type":"portal","x":"9064","z":"-264"},"ugignremz79":{"id":"ugignremz79","type":"portal","x":"9944","z":"-488"},"2qfm55h4ioq":{"id":"2qfm55h4ioq","type":"portal","x":"10328","z":"-520"},"ymbz3mc90zk":{"id":"ymbz3mc90zk","type":"portal","x":"10984","z":"-600"},"m1iptxef6pc":{"id":"m1iptxef6pc","type":"portal","x":"9256","z":"216"},"5b1462rxzs":{"id":"5b1462rxzs","type":"portal","x":"9736","z":"104"},"4r1asvglaau":{"id":"4r1asvglaau","type":"portal","x":"10280","z":"264"},"mx9aovfbek":{"id":"mx9aovfbek","type":"portal","x":"11080","z":"72"},"gszj4qml6z7":{"id":"gszj4qml6z7","type":"portal","x":"9304","z":"760"},"vr5xiqf1ip":{"id":"vr5xiqf1ip","type":"portal","x":"9896","z":"792"},"dd972ve5j3k":{"id":"dd972ve5j3k","type":"portal","x":"8632","z":"280"},"4risopt4hte":{"id":"4risopt4hte","type":"portal","x":"11192","z":"888"},"xyeppw824j":{"id":"xyeppw824j","type":"portal","x":"10360","z":"936"},"lzofohrd26n":{"id":"lzofohrd26n","type":"shipwreck","x":"10984","z":"952"},"8l26p3qrzyn":{"id":"8l26p3qrzyn","type":"smallRuin","x":"9096","z":"-1160"},"ajs0dq53ei":{"id":"ajs0dq53ei","type":"smallRuin","x":"9288","z":"-1256"},"pzwhztnlrm":{"id":"pzwhztnlrm","type":"smallRuin","x":"8968","z":"-1544"},"olqfe2kjurc":{"id":"olqfe2kjurc","type":"smallRuin","x":"9144","z":"-1896"},"cbqwj7gfbxl":{"id":"cbqwj7gfbxl","type":"largeRuin","x":"9336","z":"-1848"},"rjg17moyl5":{"id":"rjg17moyl5","type":"largeRuin","x":"9624","z":"-1784"},"y60cof8cnia":{"id":"y60cof8cnia","type":"smallRuin","x":"10040","z":"-1768"},"8tjjc3uyjow":{"id":"8tjjc3uyjow","type":"smallRuin","x":"10392","z":"-1496"},"i1nhyc6ujw8":{"id":"i1nhyc6ujw8","type":"smallRuin","x":"11016","z":"1064"},"dypqfmjo6ek":{"id":"dypqfmjo6ek","type":"largeRuin","x":"10568","z":"968"},"bwukou0qwsc":{"id":"bwukou0qwsc","type":"smallRuin","x":"9768","z":"792"},"u23sq2thi8":{"id":"u23sq2thi8","type":"smallRuin","x":"9736","z":"456"},"ipywof83tz":{"id":"ipywof83tz","type":"smallRuin","x":"9464","z":"728"},"2z7cjwwaxnl":{"id":"2z7cjwwaxnl","type":"smallRuin","x":"10744","z":"-1496"}}

				// svgInfo:
				// {"minX":"8143","maxX":"12034","minZ":"-2153","maxZ":"1215"}

				// polyList
				// {"3ecqx5ni0ty":{"id":"3ecqx5ni0ty","coords":{"0":{"x":9728,"z":-894},"1":{"x":9813,"z":-930},"2":{"x":9843,"z":-900},"3":{"x":9916,"z":-918},"4":{"x":9934,"z":-942},"5":{"x":9970,"z":-972},"6":{"x":9946,"z":-1003},"7":{"x":9958,"z":-1027},"8":{"x":9970,"z":-1051},"9":{"x":9952,"z":-1063},"10":{"x":9952,"z":-1118},"11":{"x":9982,"z":-1148},"12":{"x":10055,"z":-1124},"13":{"x":10121,"z":-1178},"14":{"x":10164,"z":-1148},"15":{"x":10145,"z":-1099},"16":{"x":10127,"z":-1075},"17":{"x":10133,"z":-1021},"18":{"x":10121,"z":-966},"19":{"x":10115,"z":-912},"20":{"x":10012,"z":-924},"21":{"x":9946,"z":-924},"22":{"x":9916,"z":-887},"23":{"x":9843,"z":-869},"24":{"x":9795,"z":-857},"25":{"x":9758,"z":-845}},"color":"#ffffff"},"q5dmzt0dt0m":{"id":"q5dmzt0dt0m","coords":{"0":{"x":10212,"z":-997},"1":{"x":10218,"z":-1063},"2":{"x":10291,"z":-1154},"3":{"x":10315,"z":-1215},"4":{"x":10357,"z":-1196},"5":{"x":10448,"z":-1263},"6":{"x":10466,"z":-1251},"7":{"x":10490,"z":-1318},"8":{"x":10569,"z":-1215},"9":{"x":10593,"z":-1221},"10":{"x":10617,"z":-1221},"11":{"x":10690,"z":-1233},"12":{"x":10708,"z":-1190},"13":{"x":10745,"z":-1184},"14":{"x":10769,"z":-1130},"15":{"x":10775,"z":-1081},"16":{"x":10714,"z":-1027},"17":{"x":10648,"z":-1075},"18":{"x":10569,"z":-1093},"19":{"x":10496,"z":-1118},"20":{"x":10424,"z":-1087},"21":{"x":10333,"z":-1045},"22":{"x":10291,"z":-978},"23":{"x":10218,"z":-990}},"color":"#ffffff"},"6vttlsh22yb":{"id":"6vttlsh22yb","coords":{"0":{"x":10430,"z":-512},"1":{"x":10496,"z":-476},"2":{"x":10503,"z":-421},"3":{"x":10563,"z":-342},"4":{"x":10533,"z":-306},"5":{"x":10490,"z":-282},"6":{"x":10454,"z":-251},"7":{"x":10375,"z":-257},"8":{"x":10351,"z":-288},"9":{"x":10351,"z":-348},"10":{"x":10339,"z":-385},"11":{"x":10369,"z":-457}},"color":"#ffffff"},"f7m5cpnto16":{"id":"f7m5cpnto16","coords":{"0":{"x":10067,"z":-185},"1":{"x":10079,"z":-136},"2":{"x":10121,"z":-94},"3":{"x":10170,"z":-70},"4":{"x":10188,"z":-9},"5":{"x":10024,"z":45},"6":{"x":9970,"z":27},"7":{"x":9934,"z":51},"8":{"x":9849,"z":-9},"9":{"x":9885,"z":-94},"10":{"x":9982,"z":-155},"11":{"x":9946,"z":-136},"12":{"x":9994,"z":-167}},"color":"#ffffff"},"gr9p9vh1ext":{"id":"gr9p9vh1ext","coords":{"0":{"x":9371,"z":-348},"1":{"x":9498,"z":-264},"2":{"x":9510,"z":-185},"3":{"x":9468,"z":-142},"4":{"x":9474,"z":-106},"5":{"x":9504,"z":-76},"6":{"x":9552,"z":-100},"7":{"x":9595,"z":-88},"8":{"x":9704,"z":9},"9":{"x":9734,"z":130},"10":{"x":9704,"z":173},"11":{"x":9631,"z":239},"12":{"x":9595,"z":203},"13":{"x":9613,"z":136},"14":{"x":9571,"z":94},"15":{"x":9444,"z":70},"16":{"x":9389,"z":-88},"17":{"x":9353,"z":-106},"18":{"x":9316,"z":-221},"19":{"x":9329,"z":-312},"20":{"x":9359,"z":-348}},"color":"#ffffff"}}

				// console.log("--document.read--");
				const markStorage = "markList",
					polyStorage = "polyList",
					svgStorage = "svgInfo",
					markTypes = {
						village: { label: "Village", color: "brown" },
						ancientCity: { label: "Ancient City", color: "aqua" },
						pillagerOutpost: { label: "Pillager Outpost", color: "maroon" },
						portal: { label: "Portal", color: "RebeccaPurple" },
						smallRuin: { label: "Small Ruin", color: "SkyBlue" },
						largeRuin: { label: "Large Ruin", color: "yellow" },
						shipwreck: { label: "Shipwreck", color: "chocolate" },
					};
				var status = { isDrawing: false },
					svgWindow = {
						width: 100,
						height: 100,
						left: 0,
						top: 0,
					},
					svgInfo = {
						minX: 0,
						maxX: svgWindow.width,
						minZ: 0,
						maxZ: svgWindow.height,
					},
					addingPoly = {},
					mousePosX,
					mousePosY,
					mouseCoordX,
					mouseCoordZ;
				const marksTableEle = $("#marksTable"),
					svgEle = $("#svg"),
					statusEle = $("#status"),
					startPolygonEle = $("#startPolygon"),
					saveCancelEle = $("#saveCancel"),
					savePolygonEle = $("#savePolygon"),
					polyColorEle = $("#polyColor"),
					cancelPolygonEle = $("#cancelPolygon"),
					polygonCoordsEle = $("#polygonCoords"),
					polyTableEle = $("#polyTable");

				// ////////
				// init
				function init() {
					// mark options
					// console.log(":::initOptions:::");
					Object.entries(markTypes).forEach(function ([val, { label }]) {
						$("#markType").append($("<option></option>").val(val).text(label));
					});

					// minMax inputs
					// console.log(":::initMinMax:::");
					const loc = _getStorage(svgStorage);
					const minMaxDisplay = Object.entries(svgInfo).reduce(function (d, [k, v]) {
						if (!loc[k]) updateMinMax(k, v);
						d[k] = Number(loc[k]) ?? v;
						return d;
					}, {});
					// console.log("minMaxDisplay: ", minMaxDisplay);
					svgInfo = minMaxDisplay;
					displayMinMax(minMaxDisplay);

					// get svg size and display marks
					getWindowSize();
				}
				init();

				// ///////////
				// helpers

				// storage
				function _setStorage(storageName, value) {
					localStorage.removeItem(storageName);
					localStorage.setItem(storageName, JSON.stringify(value));
				}
				function _getStorage(storageName) {
					return JSON.parse(localStorage.getItem(storageName) ?? "{}");
				}

				// crud
				function _genericDelete(storageName, id) {
					const oldList = _getStorage(storageName);
					const newList = Object.entries(oldList).reduce(function (s, [k, v]) {
						if (k !== id) s[k] = v;
						return s;
					}, {});
					_setStorage(storageName, newList);
					return newList;
				}
				function createMark(value) {
					// console.log("--createMark--");
					const type = $("#markType").val(),
						id = createID(),
						oldList = _getStorage(markStorage);

					// validate
					if (value && type && id) {
						const valueSplit = value.split(" ");
						// console.log("valueSplit: ", valueSplit);

						// TODO: check if mark already exists in list before adding to the list

						const newMark = {
							id,
							type,
							x: valueSplit[1],
							z: valueSplit[3],
						};
						const newList = {
							...oldList,
							[id]: newMark,
						};
						// console.log("newMark: ", newMark);

						// save
						_setStorage(markStorage, newList);

						// re-render mark list only
						displayMarks(newList);

						// reset
						$("#newValue").val("");
					}
				}
				function deleteMark(id) {
					console.log("deleteMark id: ", id);
					const newList = _genericDelete(markStorage, id);
					reRender({ marks: newList });
				}
				function createID() {
					// console.log("--createID--");
					return Math.random()
						.toString(36)
						.substring(2, 12 + 2);
				}
				function updateMinMax(name, value) {
					// console.log("--updateMinMax--");
					const oldList = _getStorage(svgStorage);
					const newList = { ...oldList, [name]: value };
					svgInfo[name] = value;
					// console.log(name, ": ", value);
					_setStorage(svgStorage, newList);
				}
				function updateStatus(name, value) {
					status[name] = value;
					statusEle.html(name);
					statusEle.show();
				}
				function updateAddingPoly() {
					addingPoly[Object.keys(addingPoly).length] = { x: mouseCoordX, z: mouseCoordZ };
					polygonCoordsEle.html(polygonCoordsEle.html() + `${mouseCoordX} ${mouseCoordZ}<br/>`);

					// displayPoly(addingPoly);
					reRender({ adding: addingPoly });
				}
				function resetAddingPoly() {
					addingPoly = {};
					polygonCoordsEle.html("");
				}
				function createPoly() {
					const oldList = _getStorage(polyStorage),
						id = createID(),
						color = polyColorEle.val();

					// validate
					if (addingPoly && id) {
						const newPoly = {
							id,
							coords: addingPoly,
							color,
						};
						const newList = {
							...oldList,
							[id]: newPoly,
						};
						// add to list
						_setStorage(polyStorage, newList);
						// reset adding
						resetAddingPoly();
						// re-render
						displayPoly(newList);
						// re-start drawing
						displayDrawingPoly(false);
					}
				}
				function deletePoly(id) {
					console.log("deletePoly id: ", id);
					const newList = _genericDelete(polyStorage, id);
					reRender({ poly: newList });
				}

				// //////////
				// Render

				// display
				function displayMarks(marks = null) {
					// console.log("--displayMarks--");
					if (!marks) marks = _getStorage(markStorage);

					// clear
					marksTableEle.html("");
					svgEle.html("");

					Object.entries(marks).forEach(function ([key, mark]) {
						// console.log("mark: ", mark);
						const { id, type, x, z } = mark;

						// mark table
						marksTableEle.append(
							$(`<div>`, {
								id,
								class: "mb-1",
							})
								.append($("<div>", { style: `background:${markTypes[type].color};` }))
								.append($("<div>").text(markTypes[type].label))
								.append($("<div>").text(x))
								.append($("<div>").text(z))
								.append(
									$("<div>")
										.append($(`<i>`, { class: "fa fa-trash deleteMark", "data-markid": id, "aria-hidden": "true" }))
										.append($(`<i>`, { class: "fa fa-pencil editMark", "data-markid": id, "aria-hidden": "true" }))
								)
						);

						// svg
						svgEle.html(svgEle.html() + _genRect(10, 10, x, z, markTypes[type].color));
					});
				}
				function displayMinMax(minMaxDisplay) {
					// console.log("--displayMinMax--");
					if (!minMaxDisplay) minMaxDisplay = svgInfo;
					Object.entries(minMaxDisplay).forEach(function ([k, v]) {
						$("#" + k).val(v);
					});
				}
				function displayPoly(poly = null) {
					if (!poly) poly = _getStorage(polyStorage);

					// if addingPoly
					if (poly[0]) {
						// show svg poly
						svgEle.html(svgEle.html() + _genPoly(poly, polyColorEle.val()));
					}
					// else polyStorage
					else {
						polyTableEle.html("");
						Object.entries(poly).forEach(function ([id, { coords, color }]) {
							// svg poly
							svgEle.html(svgEle.html() + _genPoly(coords, color));

							// poly table
							polyTableEle.append(
								$(`<div>`, {
									id,
									class: "mb-2",
								})
									.append($("<div>", { style: `background:${color};` }))
									.append(
										Object.entries(coords).reduce(function (c, [k, { x, z }], i) {
											c.append($("<div>").text(x)).append($("<div>").text(z));
											return c;
										}, $("<div>"))
									)
									.append(
										$("<div>")
											.append($(`<i>`, { class: "fa fa-trash deletePoly", "data-polyid": id, "aria-hidden": "true" }))
											.append($(`<i>`, { class: "fa fa-pencil editPoly", "data-polyid": id, "aria-hidden": "true" }))
									)
							);
						});
					}
				}
				function getWindowSize() {
					// console.log("--getWindowSize--");

					svgWindow = {
						height: Math.floor(svgEle.height()),
						width: Math.floor(Math.floor(svgEle.height()) * (974 / 842)),
						top: svgEle.position().top,
						left: svgEle.position().left,
					};
					// console.log("svgWindow: ", svgWindow);

					// re-render
					reRender();
				}
				function reRender(renderData = null) {
					console.log("reRender renderData: ", renderData);
					const { marks, poly, adding } = renderData ?? {};
					displayMarks(marks ?? null);
					displayPoly(poly ?? null);
					if (status.isDrawing) displayPoly(adding ?? addingPoly);
				}

				function displayDrawingPoly(isOn) {
					if (isOn) {
						updateStatus("isDrawing", true);
						saveCancelEle.show();
						startPolygonEle.hide();
					} else {
						updateStatus("isDrawing", false);
						saveCancelEle.hide();
						startPolygonEle.show();
					}
					reRender();
				}

				// svg helpers
				function _genRect(width, height, x, z, fill) {
					x = _translateX(x) - width / 2;
					z = _translateZ(z) - height / 2;
					return `<rect width="${width}" height="${height}" x="${x}" y="${z}" fill="${fill}" />`;
				}
				function _genPoly(polyCoords, color = "white") {
					let coords = Object.entries(polyCoords).reduce(function (s, [k, { x, z }], i) {
						x = _translateX(x);
						z = _translateZ(z);
						return s + `${x},${z} `;
					}, "");
					// console.log("coords: ", coords);
					return `<polygon points="${coords}" fill="${color}" />`;
				}
				function _translateX(x) {
					return Math.round(Math.abs((x - svgInfo.minX) / (svgInfo.maxX - svgInfo.minX)) * svgWindow.width);
				}
				function _translateZ(z) {
					return Math.round(Math.abs((z - svgInfo.minZ) / (svgInfo.maxZ - svgInfo.minZ)) * svgWindow.height);
				}

				// ///////////
				// on handlers

				// display
				$("#reset").on("click", function () {
					reRender();
				});

				// new mark
				$("#newValue").on("keypress", function (e) {
					// console.log("--#newValue on keypress--");
					const v = e.target.value;
					// if enter key
					if (e.which == 13 && v) {
						createMark(v);
					}
				});
				$("#submit").on("click", function (e) {
					// console.log("--#submit on click--");
					const v = $("#newValue").val();
					if (v) createMark(v);
				});
				$(document).on("click", ".deleteMark", function () {
					deleteMark($(this).data("markid"));
				});

				// min max
				$(".minMax").on("change click keyup input paste", function (e) {
					// console.log("--.minMax on change--");
					updateMinMax(e.target.name, e.target.value);
				});

				// window resize
				$(window).on("resize", function () {
					getWindowSize();
				});

				// svg
				svgEle.on("mousemove", function (event) {
					mousePosX = Math.floor(event.pageX - svgWindow.left);
					mousePosY = Math.floor(event.pageY - svgWindow.top);
					$("#mousePosX").text(mousePosX);
					$("#mousePosY").text(mousePosY);

					mouseCoordX = Math.floor((mousePosX / svgWindow.width) * Math.abs(svgInfo.maxX - svgInfo.minX) + svgInfo.minX);
					mouseCoordZ = Math.floor((mousePosY / svgWindow.height) * Math.abs(svgInfo.maxZ - svgInfo.minZ) + svgInfo.minZ);
					$("#mouseCoordX").text(mouseCoordX);
					$("#mouseCoordZ").text(mouseCoordZ);
				});

				// draw polygon
				startPolygonEle.on("click", function () {
					displayDrawingPoly(true);
				});
				svgEle.on("click", function () {
					if (status.isDrawing) {
						updateAddingPoly();
					}
				});
				savePolygonEle.on("click", function () {
					createPoly();
				});
				cancelPolygonEle.on("click", function () {
					displayDrawingPoly(false);
				});
				polyColorEle.on("change", function () {
					console.log("polyColorEle on");
					displayPoly(addingPoly);
				});
				$(document).on("click", ".deletePoly", function () {
					deletePoly($(this).data("polyid"));
				});
			});
		</script>
	</body>
</html>
